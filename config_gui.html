<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>LLM Benchmark Agent Configuration</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "IBM Plex Sans", "Segoe UI", "Helvetica Neue", sans-serif;
        --bg: #f3f7fc;
        --card: #ffffff;
        --ink: #16253a;
        --muted: #4c5f78;
        --line: #cfdceb;
        --accent: #1f66b1;
        --accent-soft: #e6f1fb;
        --control-height: 2.35rem;
        --required: #b54708;
        --required-soft: #fff2e8;
        --flag: #0050a4;
        --value: #1f7a1f;
        --script: #7a1f7a;
        --binary: #8f4a00;
      }
      body {
        margin: 0;
        padding: 1.5rem;
        line-height: 1.45;
        color: var(--ink);
        background:
          radial-gradient(circle at top right, #d9ecff 0%, rgba(217, 236, 255, 0) 50%),
          radial-gradient(circle at bottom left, #e8f6e8 0%, rgba(232, 246, 232, 0) 55%),
          var(--bg);
      }
      .page {
        max-width: 1320px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 1fr) 370px;
        gap: 1.25rem;
        align-items: start;
      }
      .main-column {
        min-width: 0;
      }
      .page-header {
        margin-bottom: 1rem;
      }
      h1 {
        margin: 0 0 0.5rem;
        letter-spacing: 0.01em;
      }
      .subtitle {
        margin: 0;
        color: var(--muted);
      }
      fieldset {
        border: 1px solid var(--line);
        background: var(--card);
        border-radius: 12px;
        padding: 0.95rem 1.35rem;
        margin: 0 0 1rem;
        box-shadow: 0 6px 16px rgba(22, 37, 58, 0.045);
      }
      legend {
        font-weight: 700;
        padding: 0 0.5rem;
        color: var(--ink);
      }
      .section-lead {
        margin-top: 0;
        color: var(--muted);
      }
      .required-card {
        border-color: #f0b487;
        background: linear-gradient(180deg, #fffefc 0%, #ffffff 100%);
      }
      .required-field input,
      .required-field textarea,
      .required-field select {
        border: 1.5px solid #f0c5a2;
        background: #fffaf5;
      }
      .required-field input:focus,
      .required-field textarea:focus,
      .required-field select:focus {
        outline: none;
        border-color: #d97706;
        box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.16);
      }
      label {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
        font-weight: 600;
      }
      label span {
        font-weight: 400;
      }
      input,
      textarea,
      select {
        margin-top: 0.35rem;
        padding: 0.38rem 0.58rem;
        font-size: 0.98rem;
        font-family: inherit;
        border: 1px solid #b8cadd;
        border-radius: 8px;
        box-sizing: border-box;
        transition:
          border-color 140ms ease,
          box-shadow 140ms ease,
          background-color 140ms ease;
      }
      input:not([type="checkbox"]),
      select {
        height: var(--control-height);
        width: 100%;
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #5f8fc1;
        box-shadow: 0 0 0 2px rgba(95, 143, 193, 0.15);
      }
      input[type="checkbox"] {
        min-height: initial;
        width: 1rem;
        height: 1rem;
        flex: 0 0 1rem;
        border-radius: 4px;
        accent-color: #2f7abf;
        vertical-align: middle;
        position: relative;
        top: 0;
        margin: 0;
      }
      textarea {
        width: 100%;
        min-height: 7rem;
        resize: vertical;
        line-height: 1.4;
      }
      #input_path {
        min-height: 6.4rem;
      }
      #system_prompt {
        min-height: 6.8rem;
      }
      input[type="number"] {
        padding-right: 0.45rem;
      }
      select {
        appearance: auto;
        background-color: #fff;
      }
      label {
        gap: 0.06rem;
      }
      .inline {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        min-height: var(--control-height);
      }
      .inline span {
        font-weight: 400;
      }
      .inline input[type="checkbox"] {
        width: 1.05rem;
        height: 1.05rem;
      }
      .hint {
        display: block;
        font-size: 0.88rem;
        color: var(--muted);
        margin-top: 0.28rem;
        line-height: 1.35;
      }
      .tool-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem 1rem;
        margin-bottom: 1rem;
        align-items: center;
      }
      .catalog-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.2rem;
      }
      .catalog-controls .hint {
        margin-top: 0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 0.85rem 1.35rem;
        align-items: start;
      }
      .grid.compact {
        gap: 0.55rem 1rem;
      }
      details.optional-group {
        border: 1px dashed var(--line);
        border-radius: 10px;
        padding: 0.7rem 0.85rem 0.15rem;
        margin: 0.75rem 0;
        background: #fcfdff;
      }
      details.optional-group > summary {
        cursor: pointer;
        font-weight: 700;
        color: #1c4f82;
        margin-bottom: 0.55rem;
      }
      details.optional-group[open] > summary {
        margin-bottom: 0.8rem;
      }
      pre {
        background: #f5f8fc;
        padding: 1rem;
        overflow-x: auto;
        white-space: pre-wrap;
        border-radius: 10px;
        border: 1px solid var(--line);
      }
      button {
        min-height: var(--control-height);
        padding: 0.35rem 0.95rem;
        font-size: 0.98rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background: var(--accent);
        color: white;
      }
      button:active {
        transform: translateY(1px);
      }
      .input-with-action {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        margin-top: 0.35rem;
      }
      .input-with-action input {
        margin-top: 0;
        flex: 1;
      }
      .clear-model-button {
        flex: 0 0 auto;
        width: var(--control-height);
        height: var(--control-height);
        margin-top: 0;
        padding: 0;
        font-weight: 700;
        font-size: 1.05rem;
        line-height: 1;
        border-radius: 8px;
        background: #2b6cb5;
      }
      input[list]::-webkit-calendar-picker-indicator {
        display: none;
      }
      .command-panel {
        position: sticky;
        top: 1rem;
        border: 1px solid #bdd4ec;
        background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 12px 24px rgba(31, 102, 177, 0.12);
      }
      .command-panel h2 {
        margin: 0 0 0.35rem;
      }
      .panel-note {
        margin: 0 0 0.8rem;
        color: var(--muted);
        font-size: 0.92rem;
      }
      code {
        font-weight: bolder;
      }
      .command-preview {
        min-height: 160px;
      }
      .cmd-token {
        word-break: break-word;
      }
      .cmd-space {
        white-space: pre;
      }
      .cmd-bin {
        color: var(--binary);
        font-weight: 700;
      }
      .cmd-script {
        color: var(--script);
        font-weight: 600;
      }
      .cmd-flag {
        color: var(--flag);
        font-weight: 700;
      }
      .cmd-value {
        color: var(--value);
      }
      .cmd-plain {
        color: var(--ink);
      }
      .command-actions {
        display: flex;
        gap: 0.6rem;
      }
      .cli-help {
        margin-top: 1rem;
      }
      .cli-help summary {
        cursor: pointer;
        font-weight: 700;
      }
      @media (max-width: 1060px) {
        .page {
          grid-template-columns: 1fr;
        }
        .command-panel {
          position: static;
          order: -1;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <main class="main-column">
        <header class="page-header">
          <h1>LLM Linguistic Classification Benchmark Agent</h1>
          <p class="subtitle">
            Required inputs are highlighted first. Optional and advanced controls are collapsed to reduce visual clutter.
          </p>
        </header>

        <form id="config-form">
          <fieldset class="required-card">
            <legend>Core Setup</legend>
            <p class="section-lead">Set these first to build a runnable command.</p>
            <div class="tool-row">
              <div class="catalog-controls">
                <button type="button" id="refresh-models-button">Refresh Model List</button>
                <span class="hint">Run <code>python benchmark_agent.py --update-models</code> first, then refresh here.</span>
                <span class="hint" id="model-catalog-meta"></span>
                <span id="refresh-models-status" class="hint"></span>
              </div>
            </div>
            <div class="grid">
              <label class="required-field"
                >Input CSV Path(s)
                <textarea
                  id="input_path"
                  name="input_path"
                  placeholder="data/examples.csv&#10;data/examples_2.csv"
                  required
                ></textarea>
                <span class="hint">Provide one path per line.</span>
              </label>
              <label class="required-field"
                >Model Name
                <div class="input-with-action">
                  <input
                    type="text"
                    id="model"
                    name="model"
                    placeholder="gpt-4o-mini"
                    list="model-options"
                    required
                  />
                  <button type="button" id="model-clear-button" class="clear-model-button">x</button>
                </div>
                <datalist id="model-options"></datalist>
              </label>
              <label class="required-field"
                >Provider
                <select id="provider" name="provider">
                  <option value="openai" selected>OpenAI-Compatible</option>
                  <option value="anthropic">Anthropic (OpenAI proxy)</option>
                  <option value="cohere">Cohere (OpenAI proxy)</option>
                  <option value="google">Google (OpenAI proxy)</option>
                  <option value="huggingface">Hugging Face (OpenAI proxy)</option>
                  <option value="e-infra">E-INFRA (OpenAI proxy)</option>
                </select>
              </label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Prompt Behavior</legend>
            <label
              >System Prompt
              <span class="hint">Only this field may be base64-encoded in the generated command when multi-line text is used.</span>
              <textarea
                id="system_prompt"
                name="system_prompt"
                placeholder="You are a linguistic classifier that excels at semantic disambiguation."
              ></textarea>
            </label>
            <div class="grid compact">
              <label class="inline">
                <input type="checkbox" id="enable_cot" name="enable_cot" />
                <span>Encourage chain-of-thought reasoning</span>
              </label>
              <label class="inline">
                <input type="checkbox" id="include_explanations" name="include_explanations" checked />
                <span>Include explanations in model outputs</span>
              </label>
            </div>
          </fieldset>

          <fieldset>
            <legend>Optional Runtime Controls</legend>
            <details class="optional-group">
              <summary>Sampling, pacing, and service options</summary>
              <div class="grid">
                <label
                  >Temperature
                  <input type="number" step="0.01" min="0" max="2" id="temperature" name="temperature" placeholder="(optional)" />
                </label>
                <label
                  >Top-p
                  <input type="number" step="0.01" min="0" max="1" id="top_p" name="top_p" placeholder="(optional)" />
                </label>
                <label
                  >Top-k
                  <input type="number" min="1" id="top_k" name="top_k" placeholder="(optional)" />
                </label>
                <label
                  >Request Interval (ms)
                  <input type="number" min="0" step="1" id="request_interval_ms" name="request_interval_ms" value="0" />
                </label>
                <label
                  >OpenAI Service Tier
                  <select id="service_tier" name="service_tier">
                    <option value="standard" selected>Standard</option>
                    <option value="flex">Flex</option>
                    <option value="priority">Priority</option>
                  </select>
                </label>
                <label
                  >GPT Reasoning Effort
                  <select id="reasoning_effort" name="reasoning_effort">
                    <option value="" selected>(omit)</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                  </select>
                </label>
                <label
                  >Gemini Thinking Level
                  <select id="thinking_level" name="thinking_level">
                    <option value="" selected>(omit)</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                  </select>
                </label>
                <label
                  >Claude Effort
                  <select id="effort" name="effort">
                    <option value="" selected>(omit)</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="max">Max</option>
                  </select>
                </label>
                <label
                  >Few-shot Examples
                  <input type="number" min="0" id="few_shot_examples" name="few_shot_examples" value="0" />
                </label>
              </div>
            </details>

            <details class="optional-group">
              <summary>Input/output extras and credentials</summary>
              <div class="grid">
                <label
                  >Labels CSV Path
                  <input type="text" id="labels_path" name="labels_path" placeholder="data/labels.csv" />
                </label>
                <label
                  >Output CSV Path
                  <input type="text" id="output_path" name="output_path" placeholder="results/" />
                  <span class="hint">Provide a directory when batching multiple files.</span>
                </label>
                <label
                  >API Key Environment Variable
                  <input type="text" id="api_key_var" name="api_key_var" placeholder="OPENAI_API_KEY" />
                  <span class="hint">Leave blank to use the provider default.</span>
                </label>
                <label
                  >API Base URL Environment Variable
                  <input type="text" id="api_base_var" name="api_base_var" placeholder="OPENAI_BASE_URL" />
                  <span class="hint">Leave blank to use the provider default endpoint variable.</span>
                </label>
              </div>
              <label class="inline">
                <input type="checkbox" id="calibration" name="calibration" />
                <span>Enable calibration plot</span>
              </label>
            </details>
          </fieldset>

          <fieldset>
            <legend>Advanced Validator (Optional)</legend>
            <details class="optional-group">
              <summary>Configure external validator and retry behavior</summary>
              <p class="section-lead">
                Useful for very large label spaces. The validator can accept, normalize, or request retries with a smaller candidate set.
              </p>
              <label class="inline">
                <input type="checkbox" id="validator_enable" name="validator_enable" />
                <span>Enable validator</span>
              </label>
              <div class="grid">
                <label
                  >Validator command
                  <span class="hint">Executable path or a <code>.py</code> script (runs via current Python).</span>
                  <input type="text" id="validator_cmd" name="validator_cmd" placeholder="validators/lemmatization_validator.py" />
                </label>
                <label
                  >Validator args
                  <span class="hint">Single string passed to <code>--validator_args</code> (supports quoting).</span>
                  <input
                    type="text"
                    id="validator_args"
                    name="validator_args"
                    placeholder="--lexicon data/lemmas.txt --max_distance 2 --max_suggestions 30"
                  />
                </label>
                <label
                  >Validator timeout (s)
                  <input type="number" step="0.1" min="0.1" id="validator_timeout" name="validator_timeout" value="5.0" />
                </label>
                <label
                  >Max candidates
                  <input type="number" min="1" id="validator_prompt_max_candidates" name="validator_prompt_max_candidates" value="50" />
                </label>
                <label
                  >Max retry prompt chars
                  <input type="number" min="100" id="validator_prompt_max_chars" name="validator_prompt_max_chars" value="8000" />
                </label>
                <label
                  >Exhausted policy
                  <select id="validator_exhausted_policy" name="validator_exhausted_policy">
                    <option value="accept_blank_confidence" selected>Accept, blank confidence</option>
                    <option value="unclassified">Force unclassified</option>
                    <option value="error">Abort run</option>
                  </select>
                </label>
              </div>
              <label class="inline">
                <input type="checkbox" id="validator_debug" name="validator_debug" />
                <span>Debug validator traffic (requires DEBUG log level)</span>
              </label>
            </details>
          </fieldset>
        </form>

        <details class="cli-help">
          <summary>CLI Help Reference</summary>
          <p class="hint">
            For the full current reference, run <code>python benchmark_agent.py --help</code> in your terminal.
          </p>
          <pre>usage: benchmark_agent.py [-h] [--input INPUT [INPUT ...]] [--labels LABELS]
                          [--output OUTPUT] [--model MODEL]
                          [--temperature TEMPERATURE] [--top_p TOP_P]
                          [--top_k TOP_K]
                          [--service_tier {standard,flex,priority}]
                          [--reasoning_effort {low,medium,high}]
                          [--thinking_level {low,medium,high}]
                          [--effort {low,medium,high,max}]
                          [--provider PROVIDER]
                          [--system_prompt SYSTEM_PROMPT | --system_prompt_b64 SYSTEM_PROMPT_B64]
                          [--few_shot_examples FEW_SHOT_EXAMPLES]
                          [--enable_cot] [--no_explanation] [--calibration]
                          [--api_key_var API_KEY_VAR]
                          [--api_base_var API_BASE_VAR]
                          [--max_retries MAX_RETRIES]
                          [--retry_delay RETRY_DELAY]
                          [--request_interval_ms REQUEST_INTERVAL_MS]
                          [--validator_cmd VALIDATOR_CMD]
                          [--validator_args VALIDATOR_ARGS]
                          [--validator_timeout VALIDATOR_TIMEOUT]
                          [--validator_prompt_max_candidates VALIDATOR_PROMPT_MAX_CANDIDATES]
                          [--validator_prompt_max_chars VALIDATOR_PROMPT_MAX_CHARS]
                          [--validator_exhausted_policy {accept_blank_confidence,unclassified,error}]
                          [--validator_debug] [--log_level LOG_LEVEL]
                          [--update-models] [--models-output MODELS_OUTPUT]
                          [--models-providers MODELS_PROVIDERS [MODELS_PROVIDERS ...]]

Benchmark an OpenAI model on a linguistic classification dataset.

options:
  -h, --help            show this help message and exit
  --input INPUT [INPUT ...]
                        Path(s) to input CSV file(s) with examples.
  --labels LABELS       Optional path to CSV file that provides ground-truth
                        labels (ID;truth).
  --output OUTPUT       Optional output CSV path or directory. When omitted,
                        defaults to &lt;input&gt;_out_&lt;model&gt;_&lt;timestamp&gt;.csv
                        alongside each input file. If the resolved output CSV
                        already exists, the run resumes from the first ID not
                        present in that file.
  --model MODEL         Model name (e.g., gpt-4-turbo).
  --temperature TEMPERATURE
                        Sampling temperature. Omit to let the provider/model
                        use its default.
  --top_p TOP_P         Nucleus sampling parameter. Omit to let the
                        provider/model use its default.
  --top_k TOP_K         Top-k sampling (ignored for APIs that do not support
                        it).
  --service_tier {standard,flex,priority}
                        Optional service-tier hint for providers that support
                        differentiated throughput.
  --reasoning_effort {low,medium,high}
                        Optional GPT/OpenAI reasoning effort level. Sent as
                        reasoning.effort when provided.
  --thinking_level {low,medium,high}
                        Optional Gemini thinking level. Sent as thinkingLevel
                        when provided.
  --effort {low,medium,high,max}
                        Optional Claude effort level. Sent as effort when
                        provided.
  --provider PROVIDER   Model provider identifier used to look up default
                        credentials. Known providers are preconfigured; custom
                        providers are inferred from &lt;PROVIDER&gt;_API_KEY and
                        &lt;PROVIDER&gt;_BASE_URL.
  --system_prompt SYSTEM_PROMPT
                        System prompt injected into the chat completion.
  --system_prompt_b64 SYSTEM_PROMPT_B64
                        Base64-encoded system prompt (used by the GUI to
                        ensure cross-platform commands).
  --few_shot_examples FEW_SHOT_EXAMPLES
                        Number of labeled examples to prepend as few-shot
                        demonstrations.
  --enable_cot          If set, encourages the model to reason step-by-step
                        before answering.
  --no_explanation      Skip requesting explanations to reduce token usage.
  --calibration         Generate a calibration plot using the model's
                        confidences.
  --api_key_var API_KEY_VAR
                        Environment variable name that stores the API key.
  --api_base_var API_BASE_VAR
                        Environment variable name that stores the API base
                        URL.
  --max_retries MAX_RETRIES
                        Maximum number of retry attempts per example on API
                        errors.
  --retry_delay RETRY_DELAY
                        Delay (seconds) between API retries.
  --request_interval_ms REQUEST_INTERVAL_MS
                        Minimum delay in milliseconds between outgoing API
                        requests. Use 0 to disable request pacing.
  --validator_cmd VALIDATOR_CMD
                        Optional path to an NDJSON validator
                        executable/script. When provided, the agent will
                        validate each prediction and may retry with extra
                        constraints. If the path ends with .py it will be run
                        via the current Python interpreter.
  --validator_args VALIDATOR_ARGS
                        Optional extra arguments passed to the validator
                        command as a single string (supports quoting).
                        Example: "--lexicon data/lemmas.txt --max_distance 2".
  --validator_timeout VALIDATOR_TIMEOUT
                        Timeout (seconds) for each validator request/response
                        roundtrip.
  --validator_prompt_max_candidates VALIDATOR_PROMPT_MAX_CANDIDATES
                        Maximum number of allowed_labels candidates rendered
                        into a validator retry prompt.
  --validator_prompt_max_chars VALIDATOR_PROMPT_MAX_CHARS
                        Maximum character length of the validator retry
                        instruction appended to the prompt.
  --validator_exhausted_policy {accept_blank_confidence,unclassified,error}
                        What to do when the validator keeps requesting retry
                        but --max_retries is exhausted.
                        accept_blank_confidence keeps the last label but
                        blanks confidence; unclassified forces label to
                        "unclassified"; error aborts the run.
  --validator_debug     Log validator NDJSON send/receive payloads at DEBUG
                        level.
  --log_level LOG_LEVEL
                        Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL).
  --update-models, -updatemodels
                        If set, fetch available models for configured
                        providers and update config_models.js.
  --models-output MODELS_OUTPUT
                        Output path for generated model catalog JS when
                        --update-models is used.
  --models-providers MODELS_PROVIDERS [MODELS_PROVIDERS ...]
                        Optional list of provider slugs to update when
                        --update-models is specified. Custom slugs are
                        allowed; env vars are inferred as &lt;SLUG&gt;_API_KEY and
                        &lt;SLUG&gt;_BASE_URL.

Tip: this GUI is a command builder. You can still edit any generated CLI flag manually before running.</pre>
        </details>
      </main>

      <aside class="command-panel">
        <h2>Live Command</h2>
        <p class="panel-note">Updates as you edit fields. Flags and values are color-coded for quick scanning.</p>
        <pre id="command-output" class="command-preview">python benchmark_agent.py --input "" --model ""</pre>
        <div class="command-actions">
          <button type="button" id="copy-button">Copy Command</button>
        </div>
      </aside>
    </div>

    <script src="config_models.js"></script>
    <script>
      let isInitializing = true;
      let latestCommandText = 'python benchmark_agent.py --input "" --model ""';

      const STORAGE_KEY = "benchmarkAgentConfig.v1";

      const form = document.getElementById("config-form");
      const commandOutput = document.getElementById("command-output");
      const copyButton = document.getElementById("copy-button");
      const providerSelect = document.getElementById("provider");
      const apiKeyVarInput = document.getElementById("api_key_var");
      const apiBaseVarInput = document.getElementById("api_base_var");
      const refreshModelsButton = document.getElementById("refresh-models-button");
      const refreshModelsStatus = document.getElementById("refresh-models-status");
      const modelInput = document.getElementById("model");
      const modelClearButton = document.getElementById("model-clear-button");
      const modelList = document.getElementById("model-options");
      const modelCatalogMeta = document.getElementById("model-catalog-meta");
      let modelCatalog =
        window.MODEL_CATALOG && typeof window.MODEL_CATALOG === "object"
          ? window.MODEL_CATALOG
          : {};

      const defaultValues = {
        provider: "openai",
        temperature: "",
        top_p: "",
        reasoning_effort: "",
        thinking_level: "",
        effort: "",
        request_interval_ms: "0",
        few_shot_examples: "0",
        service_tier: "standard",
        include_explanations: true,
        api_key_var: "",
        api_base_var: "",
        system_prompt:
          "You are a linguistic classifier that excels at semantic disambiguation.",
        validator_enable: false,
        validator_cmd: "",
        validator_args: "",
        validator_timeout: "5.0",
        validator_prompt_max_candidates: "50",
        validator_prompt_max_chars: "8000",
        validator_exhausted_policy: "accept_blank_confidence",
        validator_debug: false,
      };

      const providerDefaults = {
        openai: { apiKeyVar: "OPENAI_API_KEY", apiBaseVar: "OPENAI_BASE_URL" },
        anthropic: {
          apiKeyVar: "ANTHROPIC_API_KEY",
          apiBaseVar: "ANTHROPIC_BASE_URL",
        },
        cohere: { apiKeyVar: "COHERE_API_KEY", apiBaseVar: "COHERE_BASE_URL" },
        google: { apiKeyVar: "GOOGLE_API_KEY", apiBaseVar: "GOOGLE_BASE_URL" },
        huggingface: {
          apiKeyVar: "HF_API_KEY",
          apiBaseVar: "HF_BASE_URL",
        },
        "e-infra": {
          apiKeyVar: "E-INFRA_API_KEY",
          apiBaseVar: "E-INFRA_BASE_URL",
        },
      };
      const knownProviderLabels = {
        openai: "OpenAI-Compatible",
        anthropic: "Anthropic (OpenAI proxy)",
        cohere: "Cohere (OpenAI proxy)",
        google: "Google (OpenAI proxy)",
        huggingface: "Hugging Face (OpenAI proxy)",
        "e-infra": "E-INFRA (OpenAI proxy)",
      };
      const inputHelpTextById = {
        input_path: "One or more CSV input files. Use one path per line.",
        model: "Model identifier. Click and pick from cached models or type your own model id.",
        provider: "Provider slug used by --provider. Refresh updates this list from config_models.js.",
        system_prompt: "Optional system prompt. Multi-line prompts are encoded as --system_prompt_b64.",
        enable_cot: "Encourage model to 'Think ... step-by-step' to elicit chain-of-thought behaviour.",
        include_explanations: "If unchecked, adds --no_explanation to request compact model outputs.",
        temperature: "Optional temperature sampling value. Leave blank to omit this parameter.",
        top_p: "Optional nucleus sampling parameter. Leave blank to omit this parameter.",
        top_k: "Optional top-k sampling parameter, if your provider supports it.",
        request_interval_ms: "Minimum delay in milliseconds between API requests.",
        service_tier: "OpenAI-compatible service tier. Ignored by providers that do not support it.",
        reasoning_effort: "GPT/OpenAI reasoning effort level (low, medium, high). Adds --reasoning_effort.",
        thinking_level: "Gemini thinking level (low, medium, high). Adds --thinking_level.",
        effort: "Claude effort control (low, medium, high, max). Adds --effort.",
        few_shot_examples: "Number of few-shot examples pulled from labels to include in prompt.",
        labels_path: "Optional labels CSV path. If omitted, labels are expected in the input file.",
        output_path: "Output CSV file path, or output directory when running multiple inputs.",
        api_key_var: "Environment variable that stores the API key used for this run.",
        api_base_var: "Environment variable containing the provider base URL.",
        calibration: "Generate calibration outputs in addition to regular metrics.",
        validator_enable: "Enable external validator roundtrip and retry logic.",
        validator_cmd: "Executable or .py script path used for label validation.",
        validator_args: "Raw argument string passed to validator via --validator_args.",
        validator_timeout: "Timeout in seconds for each validator invocation.",
        validator_prompt_max_candidates: "Max candidate labels shown in validator retry prompts.",
        validator_prompt_max_chars: "Hard cap for validator retry prompt character length.",
        validator_exhausted_policy: "Action when validator retries are exhausted.",
        validator_debug: "Emit verbose validator payload logging (DEBUG mode).",
      };

      function getWindowModelCatalog() {
        return window.MODEL_CATALOG && typeof window.MODEL_CATALOG === "object"
          ? window.MODEL_CATALOG
          : {};
      }

      function providerSlugToEnvPrefix(slug) {
        const safe = (slug || "")
          .toString()
          .trim()
          .toUpperCase()
          .replace(/[^A-Z0-9]+/g, "_")
          .replace(/^_+|_+$/g, "");
        return safe || "PROVIDER";
      }

      function shellQuote(value) {
        if (value === undefined || value === null) {
          return "''";
        }
        const stringValue = String(value);
        if (!stringValue.length) {
          return "''";
        }
        if (/^[A-Za-z0-9._@%+=:,\\/\\-]+$/.test(stringValue)) {
          return stringValue;
        }
        const escaped = stringValue.replace(/'/g, "'\"'\"'");
        return "'" + escaped + "'";
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function classifyCommandToken(token, index, tokens) {
        if (index === 0) return "cmd-bin";
        if (index === 1) return "cmd-script";
        if (token.startsWith("--")) return "cmd-flag";
        const prev = tokens[index - 1] || "";
        if (prev.startsWith("--")) return "cmd-value";
        return "cmd-plain";
      }

      function renderCommandTokens(tokens) {
        return tokens
          .map((token, index) => {
            const cls = classifyCommandToken(token, index, tokens);
            return `<span class="cmd-token ${cls}">${escapeHtml(token)}</span>`;
          })
          .join('<span class="cmd-space"> </span>');
      }

      function encodeSystemPromptForCli(value) {
        if (typeof value !== "string" || !value.length) {
          return "";
        }
        const normalized = value.replace(/\r\n?/g, "\n");
        if (window.TextEncoder) {
          const encoder = new TextEncoder();
          const bytes = encoder.encode(normalized);
          let binary = "";
          bytes.forEach((byte) => {
            binary += String.fromCharCode(byte);
          });
          return window.btoa(binary);
        }
        // Fallback for older browsers without TextEncoder.
        return window.btoa(unescape(encodeURIComponent(normalized)));
      }

      function promptNeedsEncoding(value) {
        if (typeof value !== "string" || !value.length) {
          return false;
        }
        return /[\r\n]/.test(value);
      }

      function updateModelOptionsForProvider(provider) {
        if (!modelList) {
          return;
        }
        modelList.innerHTML = "";
        const entry = modelCatalog[provider];
        const models =
          entry && Array.isArray(entry.models) ? entry.models.filter((value) => typeof value === "string") : [];
        if (models.length) {
          models.forEach((modelId) => {
            const option = document.createElement("option");
            option.value = modelId;
            modelList.appendChild(option);
          });
        }
        if (modelCatalogMeta) {
          let note = "";
          if (models.length) {
            note = `Loaded ${models.length} cached model${models.length === 1 ? "" : "s"} for "${provider}".`;
            if (entry && typeof entry.timestamp === "string") {
              note += ` Updated ${entry.timestamp}.`;
            }
            if (entry && entry.error) {
              note += ` Last fetch issue: ${entry.error}.`;
            }
          } else {
            note = `No cached models for "${provider}". Run python benchmark_agent.py --update-models to refresh.`;
          }
          modelCatalogMeta.textContent = note;
        }
      }
      function buildCommand() {
        const data = new FormData(form);
        const args = ["python", "benchmark_agent.py"];

        const inputRaw = (data.get("input_path") ?? "").toString();
        const inputPaths = inputRaw
          .split(/\r?\n/)
          .map((entry) => entry.trim())
          .filter((entry) => entry.length > 0);
        args.push("--input");
        if (inputPaths.length === 0) {
          args.push(shellQuote(""));
        } else {
          for (const inputPath of inputPaths) {
            args.push(shellQuote(inputPath));
          }
        }

        const modelValue = data.get("model")?.toString().trim() ?? "";
        args.push("--model", shellQuote(modelValue));

        const outputValue = data.get("output_path")?.toString().trim();
        if (outputValue) {
          args.push("--output", shellQuote(outputValue));
        }

        const provider = data.get("provider");
        if (provider && provider !== defaultValues.provider) {
          args.push("--provider", provider);
        }

        const temperature = data.get("temperature")?.trim();
        if (temperature && temperature !== defaultValues.temperature) {
          args.push("--temperature", temperature);
        }

        const topP = data.get("top_p")?.trim();
        if (topP && topP !== defaultValues.top_p) {
          args.push("--top_p", topP);
        }

        const topK = data.get("top_k")?.trim();
        if (topK) {
          args.push("--top_k", topK);
        }

        const requestIntervalMs = data.get("request_interval_ms")?.trim();
        if (requestIntervalMs && requestIntervalMs !== defaultValues.request_interval_ms) {
          args.push("--request_interval_ms", requestIntervalMs);
        }

        const serviceTier = data.get("service_tier");
        if (serviceTier && serviceTier !== defaultValues.service_tier) {
          args.push("--service_tier", serviceTier);
        }

        const reasoningEffort = data.get("reasoning_effort");
        if (reasoningEffort && reasoningEffort !== defaultValues.reasoning_effort) {
          args.push("--reasoning_effort", reasoningEffort);
        }

        const thinkingLevel = data.get("thinking_level");
        if (thinkingLevel && thinkingLevel !== defaultValues.thinking_level) {
          args.push("--thinking_level", thinkingLevel);
        }

        const effort = data.get("effort");
        if (effort && effort !== defaultValues.effort) {
          args.push("--effort", effort);
        }

        const fewShot = data.get("few_shot_examples")?.trim();
        if (fewShot && Number(fewShot) > 0) {
          args.push("--few_shot_examples", fewShot);
        }

        const labelsPath = data.get("labels_path")?.trim();
        if (labelsPath) {
          args.push("--labels", shellQuote(labelsPath));
        }

        const rawSystemPrompt = data.get("system_prompt");
        const trimmedSystemPrompt =
          typeof rawSystemPrompt === "string" ? rawSystemPrompt.trim() : "";
        if (trimmedSystemPrompt && trimmedSystemPrompt !== defaultValues.system_prompt) {
          if (promptNeedsEncoding(trimmedSystemPrompt)) {
            const serializedPrompt = encodeSystemPromptForCli(trimmedSystemPrompt);
            if (serializedPrompt) {
              args.push("--system_prompt_b64", serializedPrompt);
            }
          } else {
            args.push("--system_prompt", shellQuote(trimmedSystemPrompt));
          }
        }

        if (data.get("enable_cot")) {
          args.push("--enable_cot");
        }

        if (!data.get("include_explanations")) {
          args.push("--no_explanation");
        }

        if (data.get("calibration")) {
          args.push("--calibration");
        }

        const apiKeyVar = data.get("api_key_var")?.trim();
        if (apiKeyVar) {
          args.push("--api_key_var", shellQuote(apiKeyVar));
        }

        const apiBaseVar = data.get("api_base_var")?.trim();
        if (apiBaseVar) {
          args.push("--api_base_var", shellQuote(apiBaseVar));
        }

        if (data.get("validator_enable")) {
          const validatorCmd = data.get("validator_cmd")?.toString().trim() ?? "";
          if (validatorCmd) {
            args.push("--validator_cmd", shellQuote(validatorCmd));

            const validatorArgs = data.get("validator_args")?.toString().trim() ?? "";
            if (validatorArgs) {
              args.push("--validator_args", shellQuote(validatorArgs));
            }

            const validatorTimeout = data.get("validator_timeout")?.toString().trim() ?? "";
            if (validatorTimeout && validatorTimeout !== defaultValues.validator_timeout) {
              args.push("--validator_timeout", validatorTimeout);
            }

            const maxCandidates = data.get("validator_prompt_max_candidates")?.toString().trim() ?? "";
            if (maxCandidates && maxCandidates !== defaultValues.validator_prompt_max_candidates) {
              args.push("--validator_prompt_max_candidates", maxCandidates);
            }

            const maxChars = data.get("validator_prompt_max_chars")?.toString().trim() ?? "";
            if (maxChars && maxChars !== defaultValues.validator_prompt_max_chars) {
              args.push("--validator_prompt_max_chars", maxChars);
            }

            const exhaustedPolicy = data.get("validator_exhausted_policy");
            if (exhaustedPolicy && exhaustedPolicy !== defaultValues.validator_exhausted_policy) {
              args.push("--validator_exhausted_policy", exhaustedPolicy);
            }

            if (data.get("validator_debug")) {
              args.push("--validator_debug");
            }
          }
        }

        latestCommandText = args.join(" ");
        commandOutput.innerHTML = renderCommandTokens(args);
      }

      function ensureProviderRegistered(slug, labelHint) {
        const upper = (labelHint || slug.toUpperCase().replace(/[^A-Z0-9]+/g, "_")).toUpperCase();
        if (!providerDefaults[slug]) {
          providerDefaults[slug] = {
            apiKeyVar: `${upper}_API_KEY`,
            apiBaseVar: `${upper}_BASE_URL`,
          };
        }
        if (!Array.from(providerSelect.options).some((opt) => opt.value === slug)) {
          const option = document.createElement("option");
          option.value = slug;
          option.textContent = knownProviderLabels[slug] || `${upper.replace(/_/g, " ")} (catalog)`;
          providerSelect.appendChild(option);
        }
      }

      function setRefreshStatus(message, isError = false) {
        if (!refreshModelsStatus) {
          return;
        }
        refreshModelsStatus.textContent = message || "";
        refreshModelsStatus.style.color = isError ? "#b00020" : "";
      }

      function syncProvidersFromCatalog() {
        if (!modelCatalog || typeof modelCatalog !== "object") {
          return;
        }
        const catalogEntries = Object.entries(modelCatalog).filter(
          ([providerSlug]) => typeof providerSlug === "string" && providerSlug.trim().length > 0
        );
        if (!catalogEntries.length) {
          return;
        }

        const catalogProviderSet = new Set(catalogEntries.map(([providerSlug]) => providerSlug));
        const selectedBefore = providerSelect.value;

        // Keep the provider dropdown aligned with config_models.js and drop stale entries.
        for (const option of Array.from(providerSelect.options)) {
          if (!catalogProviderSet.has(option.value)) {
            option.remove();
          }
        }

        for (const [providerSlug, entry] of catalogEntries) {
          ensureProviderRegistered(providerSlug, providerSlug);
          const prefix = providerSlugToEnvPrefix(providerSlug);
          const apiKeyVar =
            entry && typeof entry.api_key_var === "string" && entry.api_key_var.trim()
              ? entry.api_key_var.trim()
              : `${prefix}_API_KEY`;
          const apiBaseVar =
            entry && typeof entry.api_base_var === "string" && entry.api_base_var.trim()
              ? entry.api_base_var.trim()
              : `${prefix}_BASE_URL`;
          providerDefaults[providerSlug] = { apiKeyVar, apiBaseVar };

          const option = Array.from(providerSelect.options).find((item) => item.value === providerSlug);
          if (option) {
            option.textContent = knownProviderLabels[providerSlug] || `${prefix.replace(/_/g, " ")} (catalog)`;
          }
        }

        if (
          selectedBefore &&
          Array.from(providerSelect.options).some((option) => option.value === selectedBefore)
        ) {
          providerSelect.value = selectedBefore;
        } else if (providerSelect.options.length > 0) {
          providerSelect.value = providerSelect.options[0].value;
        }
      }

      function loadModelCatalogScript() {
        const cacheBustedSrc = `config_models.js?ts=${Date.now()}`;
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = cacheBustedSrc;
          script.async = true;
          script.onload = () => {
            script.remove();
            resolve();
          };
          script.onerror = () => {
            script.remove();
            reject(new Error(`Unable to load ${cacheBustedSrc}`));
          };
          document.head.appendChild(script);
        });
      }

      async function refreshModelCatalogFromScript() {
        if (refreshModelsButton) {
          refreshModelsButton.disabled = true;
          refreshModelsButton.textContent = "Refreshing...";
        }
        setRefreshStatus("Refreshing provider and model list from config_models.js...");
        try {
          await loadModelCatalogScript();
          modelCatalog = getWindowModelCatalog();
          syncProvidersFromCatalog();
          updatePlaceholdersForProvider(providerSelect.value);
          updateModelOptionsForProvider(providerSelect.value);
          handleFormChange();
          setRefreshStatus("Provider and model list refreshed.");
        } catch (error) {
          console.warn(error);
          modelCatalog = getWindowModelCatalog();
          syncProvidersFromCatalog();
          updatePlaceholdersForProvider(providerSelect.value);
          updateModelOptionsForProvider(providerSelect.value);
          setRefreshStatus(
            "Could not reload config_models.js; showing the currently loaded catalog.",
            true
          );
        } finally {
          if (refreshModelsButton) {
            refreshModelsButton.disabled = false;
            refreshModelsButton.textContent = "Refresh Model List";
          }
        }
      }

      function updatePlaceholdersForProvider(provider) {
        const defaults = providerDefaults[provider] || providerDefaults.openai;
        if (!apiKeyVarInput.value) {
          apiKeyVarInput.placeholder = defaults.apiKeyVar;
        }
        if (!apiBaseVarInput.value) {
          apiBaseVarInput.placeholder = defaults.apiBaseVar;
        }
      }

      function applyInputHoverHelp() {
        Array.from(form.elements).forEach((element) => {
          if (!element || !(element instanceof HTMLElement)) {
            return;
          }
          if (element.type === "file") {
            return;
          }
          const mapped =
            (element.id && inputHelpTextById[element.id]) ||
            (element.name && inputHelpTextById[element.name]) ||
            "";
          if (mapped) {
            element.title = mapped;
          }
        });
        if (refreshModelsButton) {
          refreshModelsButton.title =
            "Reload providers and model lists directly from config_models.js without reloading the page.";
        }
        if (copyButton) {
          copyButton.title = "Copy the currently generated command line to clipboard.";
        }
        if (modelClearButton) {
          modelClearButton.title = "Clear the model input field.";
        }
      }

      function saveConfig() {
        const config = {};
        Array.from(form.elements).forEach((element) => {
          if (!element.name || element.type === "file") {
            return;
          }
          if (element.type === "checkbox") {
            config[element.name] = element.checked;
          } else {
            config[element.name] = element.value;
          }
        });
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
        } catch (error) {
          console.warn("Unable to persist configuration:", error);
        }
      }

      function loadConfig() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) {
            return;
          }
          const config = JSON.parse(stored);
          for (const [name, value] of Object.entries(config)) {
            const control = form.elements.namedItem(name);
            if (!control || control.type === "file") continue;
            if (name === "provider" && typeof value === "string") {
              const hasCatalogProviders =
                modelCatalog && typeof modelCatalog === "object" && Object.keys(modelCatalog).length > 0;
              if (hasCatalogProviders && !Object.prototype.hasOwnProperty.call(modelCatalog, value)) {
                continue;
              }
              ensureProviderRegistered(value, value);
            }
            if (control instanceof RadioNodeList) {
              continue;
            }
            if (control.type === "checkbox") {
              control.checked = Boolean(value);
            } else if (control.tagName === "SELECT") {
              control.value = value;
            } else {
              control.value = value;
            }
          }
        } catch (error) {
          console.warn("Unable to load stored configuration:", error);
        }
      }

      function handleFormChange() {
        buildCommand();
        if (!isInitializing) {
          saveConfig();
        }
      }

      function copyCommand() {
        const command = latestCommandText;
        navigator.clipboard
          .writeText(command)
          .then(() => {
            copyButton.textContent = "Copied!";
            setTimeout(() => {
              copyButton.textContent = "Copy Command";
            }, 1500);
          })
          .catch(() => {
            copyButton.textContent = "Copy failed";
            setTimeout(() => {
              copyButton.textContent = "Copy Command";
            }, 1500);
          });
      }

      modelCatalog = getWindowModelCatalog();
      syncProvidersFromCatalog();
      loadConfig();
      applyInputHoverHelp();
      updatePlaceholdersForProvider(providerSelect.value);
      updateModelOptionsForProvider(providerSelect.value);

      form.addEventListener("input", handleFormChange);
      copyButton.addEventListener("click", copyCommand);
      if (refreshModelsButton) {
        refreshModelsButton.addEventListener("click", refreshModelCatalogFromScript);
      }
      providerSelect.addEventListener("change", () => {
        modelInput.value = "";
        updatePlaceholdersForProvider(providerSelect.value);
        updateModelOptionsForProvider(providerSelect.value);
        handleFormChange();
      });
      if (modelClearButton) {
        modelClearButton.addEventListener("click", () => {
          modelInput.value = "";
          modelInput.focus();
          handleFormChange();
        });
      }

      isInitializing = false;
      handleFormChange();
    </script>
  </body>
</html>
